// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(cuid())
  walletAddress String   @unique 
  privyUserId   String   @unique
  name          String?
  avatar        String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  managedWallets ManagedWallet[]
  createdPools   Pool[] @relation("PoolCreator")
  poolParticipations PoolParticipant[]
  transactions   Transaction[]

  @@map("users")
}

model ManagedWallet {
  id             String   @id @default(cuid())
  walletId       String   @unique 
  address        String   @unique 
  encryptedPrivateKey String 
  name           String?  
  isActive       Boolean  @default(true)
  userId         String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  balances    WalletBalance[]
  transactions Transaction[]

  @@map("managed_wallets")
}

model WalletBalance {
  id              String   @id @default(cuid())
  walletId        String
  chainId         Int
  balance         String   @default("0") // Balance en wei
  balanceETH      String   @default("0") // Balance en ETH pour affichage
  lastSyncedAt    DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  wallet          ManagedWallet @relation(fields: [walletId], references: [walletId], onDelete: Cascade)

  // Un wallet ne peut avoir qu'une seule balance par cha√Æne
  @@unique([walletId, chainId])
  @@map("wallet_balances")
}

model Pool {
  id              String   @id @default(cuid())
  name            String
  nftCollection   String  
  creatorFee      Float    @default(0)
  poolAddress     String   
  poolType        PoolType
  status          PoolStatus @default(FUNDING)
  buyPrice        String
  sellPrice       String
  totalContribution Float @default(0)
  creatorId       String   
  chainId         Int      @default(360)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  creator         User         @relation("PoolCreator", fields: [creatorId], references: [id], onDelete: Cascade)
  participants    PoolParticipant[]
  transactions    Transaction[]

  @@map("pools")
}

model PoolParticipant {
  id            String   @id @default(cuid())
  poolId        String
  userId        String
  contribution  Float    @default(0)
  joinedAt      DateTime @default(now())
  isActive      Boolean  @default(true)

  // Relations
  pool          Pool     @relation(fields: [poolId], references: [id], onDelete: Cascade)
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("pool_participants")
}

model Transaction {
  id              String        @id @default(cuid())
  txHash          String        @unique
  type            TransactionType
  amount          Float
  tokenAddress    String?       // Adresse du token (null pour ETH)
  chainId         Int           // ChainId de la transaction
  status          TransactionStatus @default(PENDING)
  userId          String
  managedWalletId String
  poolId          String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  managedWallet   ManagedWallet @relation(fields: [managedWalletId], references: [id], onDelete: Cascade)
  pool            Pool?         @relation(fields: [poolId], references: [id])

  @@map("transactions")
}

enum PoolType {
  TOKEN
  COLLECTION
}

enum PoolStatus {
  FUNDING
  OFFER
  LISTING
  SOLD
  PAUSED
  CLOSED
}

enum TransactionType {
  BUY
  SELL
  TRANSFER
  DEPOSIT
  WITHDRAW
}

enum TransactionStatus {
  PENDING
  CONFIRMED
  FAILED
  CANCELLED
}
